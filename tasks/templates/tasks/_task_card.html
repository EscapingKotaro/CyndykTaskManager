<!-- tasks/_task_card.html -->
<div class="task-card {{ task.get_priority_class }} {{ task.get_status_display_class }}" 
     data-task-id="{{ task.id }}">
    
    <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ -->
    <div class="task-card-compact" onclick="toggleTaskDetails({{ task.id }})">
        <div class="task-header">
            <h4 class="task-title">{{ task.title }}</h4>
            <span class="task-status-badge">{{ task.get_status_display }}</span>
        </div>
        
        <div class="task-meta">
            <div class="task-assignee">
                üë§ {{ task.assigned_to.get_display_name }}
            </div>
            <div class="task-due-date">
                üìÖ {{ task.due_date|date:"d.m.Y" }}
                {% if task.is_overdue %}
                    <span class="overdue-badge">–ü–†–û–°–†–û–ß–ï–ù–ê</span>
                {% elif task.is_urgent %}
                    <span class="urgent-badge">–°–†–û–ß–ù–û</span>
                {% endif %}
            </div>
            {% if task.payment_amount > 0 %}
            <div class="task-payment">
                üí∞ {{ task.payment_amount }} —Ä—É–±.
            </div>
            {% endif %}
        </div>
        
        {% if task.tags %}
        <div class="task-tags">
            {% for tag in task.tags.split %}
                <span class="tag">{{ tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <!-- –î–µ—Ç–∞–ª—å–Ω—ã–π –≤–∏–¥ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div class="task-card-details" id="task-details-{{ task.id }}" style="display: none;">
        <div class="task-description">
            <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong>
            <p>{{ task.description|linebreaksbr }}</p>
        </div>
        
        <div class="task-full-meta">
            <div class="meta-row">
                <span class="meta-label">–°–æ–∑–¥–∞–Ω–∞:</span>
                <span>{{ task.created_by.get_display_name }} ({{ task.created_date|date:"d.m.Y H:i" }})</span>
            </div>
            {% if task.controlled_by %}
            <div class="meta-row">
                <span class="meta-label">–ù–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ:</span>
                <span>{{ task.controlled_by.get_display_name }}</span>
            </div>
            {% endif %}
            {% if task.started_date %}
            <div class="meta-row">
                <span class="meta-label">–ù–∞—á–∞—Ç–∞:</span>
                <span>{{ task.started_date|date:"d.m.Y H:i" }}</span>
            </div>
            {% endif %}
            {% if task.submitted_date %}
            <div class="meta-row">
                <span class="meta-label">–°–¥–∞–Ω–∞:</span>
                <span>{{ task.submitted_date|date:"d.m.Y H:i" }}</span>
            </div>
            {% endif %}
        </div>
        
        <div class="task-actions">
            {% if task.status == 'proposed' %}
                {% if request.user.role == 'boss' or request.user == task.controlled_by or request.user == task.assigned_to.manager %}
                <form method="post" action="{% url 'approve_task' task.id %}" class="inline-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                </form>
                {% endif %}
            {% endif %}
            
            {% if task.status == 'created' and task.assigned_to == request.user %}
            <form method="post" action="{% url 'start_task' task.id %}" class="inline-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary btn-sm">üöÄ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
            </form>
            {% endif %}
            
            {% if task.status == 'in_progress' and task.assigned_to == request.user %}
            <a href="{% url 'submit_task' task.id %}" class="btn btn-warning btn-sm">üì§ –°–¥–∞—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</a>
            {% endif %}
            
            {% if task.status == 'submitted' %}
                {% if request.user.role == 'boss' or request.user == task.controlled_by or request.user == task.created_by %}
                <a href="{% url 'complete_task' task.id %}" class="btn btn-success btn-sm">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</a>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>