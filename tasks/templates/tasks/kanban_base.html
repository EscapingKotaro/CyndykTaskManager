{% extends 'tasks/base.html' %}
{% load static %}

{% block title %}{{ page_title|default:"–ö–∞–Ω–±–∞–Ω" }} - TaskManager{% endblock %}

{% block content %}
<div class="kanban-layout">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π -->
    <aside class="kanban-sidebar">
        {% block kanban_sidebar %}
        <div class="sidebar-card">
            <div class="user-info">
                <div class="avatar-container">
                    {% if request.user.get_avatar_url %}
                    <img src="{{ request.user.get_avatar_url }}" alt="{{ request.user.get_display_name }}" class="user-avatar">
                    {% else %}
                    <div class="avatar-placeholder">üë§</div>
                    {% endif %}
                </div>
                <h2 class="user-name">{{ request.user.get_display_name }}</h2>
                <p class="user-role">{{ request.user.get_role_display }}</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ total_tasks }}</span>
                        <span class="stat-label">–∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
                    </div>
                </div>
                
                <div class="stat-card stat-success">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ total_payment }}</span>
                        <span class="stat-label">—Ä—É–±.</span>
                    </div>
                </div>
                
                {% if completed_this_month > 0 %}
                <div class="stat-card stat-warning">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <span class="stat-value">{{ completed_this_month }}</span>
                        <span class="stat-label">–∑–∞ –º–µ—Å—è—Ü</span>
                    </div>
                </div>
                {% endif %}
            </div>
            
            {% if request.user.balance > 0 %}
            <div class="balance-widget">
                <div class="balance-header">
                    <span class="balance-icon">üí≥</span>
                    <span>–ë–∞–ª–∞–Ω—Å</span>
                </div>
                <div class="balance-amount">{{ request.user.balance }} ‚ÇΩ</div>
                <div class="balance-actions">
                    <button class="btn-balance">üí∏ –í—ã–≤–µ—Å—Ç–∏</button>
                </div>
            </div>
            {% endif %}
        </div>
        {% endblock %}
    </aside>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –∫–∞–Ω–±–∞–Ω–∞ -->
    <main class="kanban-main">
        {% block kanban_header %}
        <div class="kanban-topbar">
            <div class="topbar-left">
                <h1 class="page-title">{{ header_title|default:"üóÇÔ∏è –ú–æ–π –ö–∞–Ω–±–∞–Ω" }}</h1>
                <div class="view-actions">
                    <button class="btn-view active" data-view="board">üéØ –î–æ—Å–∫–∞</button>
                    <button class="btn-view" data-view="list">üìù –°–ø–∏—Å–æ–∫</button>
                </div>
            </div>
            
            <div class="topbar-right">
                <div class="search-box">
                    <input type="text" placeholder="üîç –ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..." class="search-input">
                </div>
                <button class="btn-filter">üéõÔ∏è –§–∏–ª—å—Ç—Ä—ã</button>
            </div>
        </div>
        {% endblock %}

        <!-- –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ -->
        <div class="kanban-board">
            {% for status_code, group in status_groups.items %}
            <div class="kanban-column" data-status="{{ status_code }}">
                <div class="column-header">
                    <div class="column-title-section">
                        <h3 class="column-title">{{ group.name }}</h3>
                        <span class="column-badge">{{ group.count }}</span>
                    </div>
                    {% if group.total_payment > 0 %}
                    <div class="column-payment">üí∞ {{ group.total_payment }} ‚ÇΩ</div>
                    {% endif %}
                </div>
                
                <div class="tasks-list" id="tasks-{{ status_code }}">
                    {% for task in group.tasks %}
                    <div class="task-item" data-task-id="{{ task.id }}" draggable="true">
                        {% include 'tasks/partials/task_card_modern.html' with task=task %}
                    </div>
                    {% endfor %}
                    
                    {% if group.count == 0 %}
                    <div class="empty-column">
                        <div class="empty-icon">üéØ</div>
                        <p class="empty-text">–ù–µ—Ç –∑–∞–¥–∞—á</p>
                    </div>
                    {% endif %}
                </div>
                
                {% if status_code == 'created' %}
                <div class="column-footer">
                    <button class="btn-add-task">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </main>
</div>
{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --background: #f8fafc;
    --surface: #ffffff;
    --text: #1e293b;
    --text-light: #64748b;
    --border: #e2e8f0;
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
}

.kanban-layout {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 0;
    min-height: 100vh;
    background: var(--background);
}

/* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
.kanban-sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 1.5rem;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
}

.sidebar-card {
    background: var(--surface);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--shadow);
}

.user-info {
    text-align: center;
    margin-bottom: 2rem;
}

.avatar-container {
    width: 80px;
    height: 80px;
    margin: 0 auto 1rem;
    border-radius: 50%;
    overflow: hidden;
    border: 4px solid var(--primary);
}

.user-avatar {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: white;
}

.user-name {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin: 0 0 0.25rem 0;
}

.user-role {
    color: var(--text-light);
    margin: 0;
    font-size: 0.9rem;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-grid {
    display: grid;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-radius: 12px;
    background: var(--background);
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-primary { border-left: 4px solid var(--primary); }
.stat-success { border-left: 4px solid var(--success); }
.stat-warning { border-left: 4px solid var(--warning); }

.stat-icon {
    font-size: 1.5rem;
    margin-right: 0.75rem;
}

.stat-info {
    display: flex;
    flex-direction: column;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
}

.stat-label {
    font-size: 0.8rem;
    color: var(--text-light);
}

/* –ë–∞–ª–∞–Ω—Å */
.balance-widget {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 1.25rem;
    border-radius: 12px;
    text-align: center;
}

.balance-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    opacity: 0.9;
}

.balance-amount {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.balance-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-balance {
    flex: 1;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-balance:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
.kanban-main {
    padding: 1.5rem;
    overflow-x: auto;
}

.kanban-topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem 0;
}

.page-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text);
    margin: 0;
}

.view-actions {
    display: flex;
    background: var(--background);
    border-radius: 12px;
    padding: 0.25rem;
    margin-left: 1rem;
}

.btn-view {
    padding: 0.5rem 1rem;
    border: none;
    background: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-view.active {
    background: var(--surface);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.topbar-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.search-box {
    position: relative;
}

.search-input {
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--surface);
    width: 250px;
    font-size: 0.9rem;
}

.search-input::before {
    content: 'üîç';
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
}

.btn-filter {
    padding: 0.75rem 1.5rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-filter:hover {
    background: var(--background);
}

/* –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ */
.kanban-board {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
    align-items: start;
}

.kanban-column {
    background: var(--surface);
    border-radius: 16px;
    padding: 1.25rem;
    box-shadow: var(--shadow);
    min-height: 600px;
    border-top: 4px solid var(--border);
}

.kanban-column[data-status="proposed"] { border-top-color: #fbbf24; }
.kanban-column[data-status="created"] { border-top-color: var(--success); }
.kanban-column[data-status="in_progress"] { border-top-color: var(--primary); }
.kanban-column[data-status="submitted"] { border-top-color: var(--warning); }

.column-header {
    margin-bottom: 1.5rem;
}

.column-title-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.column-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}

.column-badge {
    background: var(--primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.column-payment {
    font-size: 0.9rem;
    color: var(--success);
    font-weight: 600;
}

.tasks-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-height: 200px;
}

.task-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    transition: all 0.3s ease;
    cursor: grab;
}

.task-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -8px rgba(0, 0, 0, 0.15);
}

.task-item:active {
    cursor: grabbing;
}

.empty-column {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-light);
}

.empty-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

.empty-text {
    margin: 0;
    font-size: 0.9rem;
}

.column-footer {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
}

.btn-add-task {
    width: 100%;
    padding: 0.75rem;
    background: var(--background);
    border: 2px dashed var(--border);
    border-radius: 8px;
    color: var(--text-light);
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-add-task:hover {
    background: var(--surface);
    border-color: var(--primary);
    color: var(--primary);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 1024px) {
    .kanban-layout {
        grid-template-columns: 280px 1fr;
    }
}

@media (max-width: 768px) {
    .kanban-layout {
        grid-template-columns: 1fr;
    }
    
    .kanban-sidebar {
        display: none;
    }
    
    .kanban-board {
        grid-template-columns: 1fr;
    }
    
    .kanban-topbar {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .topbar-left, .topbar-right {
        justify-content: center;
    }
    
    .search-input {
        width: 100%;
    }
}
</style>
{% endblock %}