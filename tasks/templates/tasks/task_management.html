{% extends 'tasks/base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ - TaskManager{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap;">
        <h1>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</h1>
        <a href="{% url 'create_task' %}" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</a>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div style="background: #f8fafc; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
        <form method="get" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div class="enhanced-input">
                <label for="search">üîç –ü–æ–∏—Å–∫</label>
                <input type="text" name="search" id="search" class="form-control" 
                       placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." value="{{ search_query }}">
            </div>
            
            <div class="enhanced-input">
                <label for="status">üìä –°—Ç–∞—Ç—É—Å</label>
                <select name="status" id="status" class="form-control">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    {% for status_code, status_name in status_choices %}
                    <option value="{{ status_code }}" {% if status_filter == status_code %}selected{% endif %}>
                        {{ status_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="enhanced-input">
                <label for="employee">üë§ –°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                <select name="employee" id="employee" class="form-control">
                    <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}" {% if employee_filter == emp.id|stringformat:"s" %}selected{% endif %}>
                        {{ emp.get_display_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="display: flex; gap: 1rem; align-items: end;">
                <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="{% url 'task_management' %}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <h2>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á ({{ tasks.count }})</h2>
    
    {% if tasks %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th style="min-width: 250px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                    <th>–°—Ä–æ–∫</th>
                    <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–æ–∑–¥–∞–Ω–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr>
                    <td>
                        <strong>{{ task.title }}</strong>
                        <div class="task-description-scrollable">
                            {{ task.description }}
                        </div>
                    </td>
                    <td>{{ task.assigned_to.get_display_name }}</td>
                    <td>{{ task.due_date }}</td>
                    <td>
                        {% if task.payment_amount == 0 %}
                            <span style="color: var(--secondary);">‚Äî</span>
                        {% else %}
                            {{ task.payment_amount }} —Ä—É–±.
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-badge status-{{ task.status }}">
                            {{ task.get_status_display }}
                        </span>
                    </td>
                    <td>{{ task.created_date|date:"d.m.Y" }}</td>
                    <td>
                        <div style="display: flex; gap: 0.3rem; flex-wrap: wrap;">
                            <a href="{% url 'task_detail' task.id %}" class="btn btn-sm btn-primary" 
                               title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅÔ∏è</a>
                            <a href="{% url 'edit_task' task.id %}" class="btn btn-sm btn-warning"
                               title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>

                            {% if task.status == 'proposed' and user.role != 'technician' %}
                            <a href="{% url 'approve_task' task.id %}" class="btn btn-sm btn-success">
                                ‚úÖ –ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—é
                            </a>
                            {% endif %}
                            
                            {% if task.status == 'submitted' %}
                            <a href="{% url 'complete_task' task.id %}" class="btn btn-sm btn-success"
                               title="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ">‚úÖ</a>
                            {% endif %}
                            
                            <a href="{% url 'delete_task' task.id %}" class="btn btn-sm btn-danger"
                               title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; color: var(--secondary);">
        <p style="font-size: 1.2rem;">üì≠ –ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞</p>
    </div>
    {% endif %}
</div>

<style>
.task-description-scrollable {
    max-height: 100px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É */
    overflow-y: auto;  /* –í–∫–ª—é—á–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
    padding: 0.5rem;
    margin-top: 0.5rem;
    background: #f8fafc;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    font-size: 0.9rem;
    line-height: 1.4;
    color: var(--secondary);
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f1f5f9;
}

.task-description-scrollable::-webkit-scrollbar {
    width: 6px;
}

.task-description-scrollable::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

.task-description-scrollable::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
}

.task-description-scrollable::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º */
.table th:nth-child(1),
.table td:nth-child(1) {
    min-width: 250px;
    max-width: 350px;
}

/* –£–ª—É—á—à–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã */
.table td {
    vertical-align: top;
    padding: 1rem 0.75rem;
}

.table th {
    padding: 1rem 0.75rem;
    background: #f8fafc;
    font-weight: 600;
    border-bottom: 2px solid #e2e8f0;
}

/* –î–µ–ª–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏ */
.table tbody tr {
    border-bottom: 1px solid #f1f5f9;
}

.table tbody tr:hover {
    background: #f8fafc;
}
.task-proposed {
    border-left: 4px solid #ffd700;
    background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);
}

.task-status-proposed {
    background: #ffd700;
    color: #856404;
}

.task-status-created {
    background: #28a745;
    color: white;
}
</style>
{% endblock %}