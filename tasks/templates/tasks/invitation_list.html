{% extends 'tasks/base.html' %}

{% block content %}
<div class="card">
    <h2>üì® –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>
    <a href="{% url 'create_invitation' %}" class="btn btn-primary">‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</a>
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Email</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°–æ–∑–¥–∞–Ω–æ</th>
                <th>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for inv in invitations %}
            <tr>
                <td>{{ inv.email }}</td>
                <td>
                    <span class="status-badge status-{{ inv.status }}">
                        {{ inv.get_status_display }}
                    </span>
                    {% if inv.accepted_by %}
                    <br><small>–ü—Ä–∏–Ω—è—Ç–æ: {{ inv.accepted_by.get_display_name }}</small>
                    {% endif %}
                </td>
                <td>{{ inv.created_at|date:"d.m.Y H:i" }}</td>
                <td>{{ inv.expires_at|date:"d.m.Y H:i" }}</td>
                <td>
                    {% if inv.status == 'pending' %}
                    <a href="#" class="btn btn-sm btn-outline copy-btn" 
                       data-url="{{ request.scheme }}://{{ request.get_host }}{% url 'register_with_invitation' inv.token %}">
                        üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<style>
.copy-btn.copied {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
    color: white !important;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.status-accepted {
    background-color: #d1edff;
    color: #004085;
}

.status-expired {
    background-color: #f8d7da;
    color: #721c24;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    const copyButtons = document.querySelectorAll('.copy-btn');
    
    copyButtons.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const url = this.getAttribute('data-url');
            copyToClipboard(url, this);
        });
    });
});

function copyToClipboard(text, button) {
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π textarea
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        // –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–º —Å–ø–æ—Å–æ–±–æ–º
        const successful = document.execCommand('copy');
        if (successful) {
            // –ú–µ–Ω—è–µ–º –≤–∏–¥ –∫–Ω–æ–ø–∫–∏ –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
            const originalText = button.innerHTML;
            button.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            button.classList.add('copied');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('copied');
            }, 2000);
        } else {
            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            prompt('üìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é:', text);
        }
    } catch (err) {
        // Fallback - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º prompt –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        prompt('üìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –≤—Ä—É—á–Ω—É—é:', text);
    } finally {
        // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
        document.body.removeChild(textArea);
    }
}
</script>
{% endblock %}